var p=(t,e,n)=>new Promise((s,c)=>{var r=o=>{try{m(n.next(o))}catch(u){c(u)}},a=o=>{try{m(n.throw(o))}catch(u){c(u)}},m=o=>o.done?s(o.value):Promise.resolve(o.value).then(r,a);m((n=n.apply(t,e)).next())});var P=document.createElement("span"),h=document.createElement("input"),g=document.createElement("button"),w=document.createElement("button"),$=document.createElement("a"),f=document.createElement("div");document.body.append(P,h,g,w,f);P.textContent="Token";g.textContent="\u722C\u53D6";w.textContent="\u4E0B\u8F7D PDF";$.textContent="\u4E0B\u8F7D JSON";$.download="hole.json";w.addEventListener("click",()=>{print()});function y(){return p(this,null,function*(){let t=new URL("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php");t.searchParams.set("action","getattention"),t.searchParams.set("PKUHelperAPI","3.0"),t.searchParams.set("jsapiver",`201027113050-${2*Math.floor(Date.now()/72e5)}`),t.searchParams.set("user_token",h.value);try{let e=yield fetch(t);if(!e.ok)return[];let{code:n,data:s}=yield e.json();if(n===0)return s}catch(e){console.error(e)}return[]})}function E(t){return p(this,null,function*(){yield new Promise(e=>setTimeout(e,500));for(let e=0;e<10;e++){let n=new URL("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php");n.searchParams.set("action","getcomment"),n.searchParams.set("pid",t.toString()),n.searchParams.set("PKUHelperAPI","3.0"),n.searchParams.set("jsapiver",`201027113050-${2*Math.floor(Date.now()/72e5)}`),n.searchParams.set("user_token",h.value);try{let s=yield fetch(n);if(!s.ok){alert("\u8FC7\u4E8E\u9891\u7E41"),yield new Promise(a=>setTimeout(a,1e3));continue}let{code:c,data:r}=yield s.json();if(c===0)return r;alert("\u9519\u8BEF"),yield new Promise(a=>setTimeout(a,1e3));continue}catch(s){console.error(s)}}return[]})}function D(t){return p(this,null,function*(){let e=yield E(t);return e.length>1&&Number(e[0].cid)>Number(e[1].cid)&&e.reverse(),e})}function v(){return p(this,null,function*(){var e,n,s,c;if(g.classList.contains("pushing"))return;g.classList.add("pushing"),f.innerHTML="";let t=[];for(let r of yield y()){let a=document.createElement("div"),m=document.createElement("div"),o=document.createElement("div");f.append(a),a.append(m);let u=Number(r.pid),l=new Date(Number(r.timestamp)*1e3);if(m.textContent=`#${u}  ${l.getFullYear()}/${l.getMonth()+1}/${l.getDate()} ${l.getHours()}:${l.getMinutes()}:${l.getSeconds()}  ${r.likenum} \u6536\u85CF  ${r.reply} \u56DE\u590D  ${(e=r.tag)!=null?e:""}
${(n=r.text)!=null?n:""}`,r.type==="image"&&typeof r.url=="string"){let i=document.createElement("img");a.append(i),u>3218523?i.src=`https://pkuhelper.pku.edu.cn/services/pkuhole/images/${r.url}`:i.src=`https://ewr1.vultrobjects.com/ph-static/images/${r.url}`}a.append(o);let b=yield D(u);for(let i of b){let k=document.createElement("div");o.append(k);let d=new Date(Number(i.timestamp)*1e3);k.textContent=`#${i.cid}  ${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}  ${(s=i.tag)!=null?s:""}
${(c=i.text)!=null?c:""}`}t.push({hole:r,comments:b})}$.href=URL.createObjectURL(new Blob([JSON.stringify(t,void 0,4)])),alert("\u5B8C\u6210"),g.classList.remove("pushing")})}h.addEventListener("keydown",t=>p(void 0,null,function*(){t.key==="Enter"&&(yield v())}));g.addEventListener("click",v);
