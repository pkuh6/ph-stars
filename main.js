var g=(t,e,n)=>new Promise((a,u)=>{var l=i=>{try{m(n.next(i))}catch(d){u(d)}},o=i=>{try{m(n.throw(i))}catch(d){u(d)}},m=i=>i.done?a(i.value):Promise.resolve(i.value).then(l,o);m((n=n.apply(t,e)).next())});function s(t,...e){let n=document.createElement(t);return n.append(...e),n}var P=s("input"),D=s("input"),y=s("input"),f=s("button","\u722C\u53D6"),j=s("button","\u4E0B\u8F7D PDF"),w=s("a","\u4E0B\u8F7D HTML"),b=s("a","\u4E0B\u8F7D JSON"),$=s("div");document.body.append(s("span","\u5F00\u59CB\u65E5\u671F"),P,s("span","\u7ED3\u675F\u65E5\u671F"),D,s("span","Token"),y,f,j,w,b,$);P.type="date";D.type="date";w.download="hole.html";b.download="hole.json";j.addEventListener("click",()=>{print()});function N(){return g(this,null,function*(){let t=new URL("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php");t.searchParams.set("action","getattention"),t.searchParams.set("PKUHelperAPI","3.0"),t.searchParams.set("jsapiver",`201027113050-${2*Math.floor(Date.now()/72e5)}`),t.searchParams.set("user_token",y.value);try{let e=yield fetch(t);if(!e.ok)return[];let{code:n,data:a}=yield e.json();if(n===0)return a}catch(e){console.error(e)}return[]})}function x(t){return g(this,null,function*(){yield new Promise(e=>setTimeout(e,250));for(let e=0;e<100;e++){let n=new URL("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php");n.searchParams.set("action","getcomment"),n.searchParams.set("pid",t.toString()),n.searchParams.set("PKUHelperAPI","3.0"),n.searchParams.set("jsapiver",`201027113050-${2*Math.floor(Date.now()/72e5)}`),n.searchParams.set("user_token",y.value);try{let a=yield fetch(n);if(!a.ok){yield new Promise(o=>setTimeout(o,3e3));continue}let{code:u,data:l}=yield a.json();if(u===0)return l;yield new Promise(o=>setTimeout(o,3e3));continue}catch(a){console.error(a)}}return alert("\u8FC7\u4E8E\u9891\u7E41"),[]})}function E(t){return g(this,null,function*(){let e=yield x(t);return e.length>1&&Number(e[0].cid)>Number(e[1].cid)&&e.reverse(),e})}function R(){return g(this,null,function*(){var o,m,i,d;if(f.classList.contains("pushing"))return;f.classList.add("pushing"),URL.revokeObjectURL(w.href),w.href="",URL.revokeObjectURL(b.href),b.href="",$.innerHTML="";let t,{value:e}=D;e.length===0?t=Math.ceil((Date.now()/1e3+28800)/86400)*86400-28800:t=Math.floor(new Date(`${e} 23:59:59`).getTime()/1e3)+1;let n=t-86400,{value:a}=P;a.length>0&&(n=Math.min(n,Math.floor(new Date(`${a} `).getTime()/1e3)));let u=[];for(let r of yield N()){let k=Number(r.timestamp);if(k<n||k>t)continue;let v=s("div"),M=s("div"),T=s("div");$.append(v),v.append(M);let L=Number(r.pid),p=new Date(k*1e3);if(M.textContent=`#${L}  ${p.getFullYear()}/${p.getMonth()+1}/${p.getDate()} ${p.getHours()}:${p.getMinutes()}:${p.getSeconds()}  ${r.likenum} \u6536\u85CF  ${r.reply} \u56DE\u590D  ${(o=r.tag)!=null?o:""}
${(m=r.text)!=null?m:""}`,r.type==="image"&&typeof r.url=="string"){let c=s("img");v.append(c),L>3218523?c.src=`https://pkuhelper.pku.edu.cn/services/pkuhole/images/${r.url}`:c.src=`https://ewr1.vultrobjects.com/ph-static/images/${r.url}`}v.append(T);let H=yield E(L);for(let c of H){let U=s("div");T.append(U);let h=new Date(Number(c.timestamp)*1e3);U.textContent=`#${c.cid}  ${h.getFullYear()}/${h.getMonth()+1}/${h.getDate()} ${h.getHours()}:${h.getMinutes()}:${h.getSeconds()}  ${(i=c.tag)!=null?i:""}
${(d=c.text)!=null?d:""}`}u.push({hole:r,comments:H})}let l=document.querySelector("style");l!==null&&(w.href=URL.createObjectURL(new Blob([`<!DOCTYPE html>
        <html>
        
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
        </head>
        
        <body>
            <style>${l.innerHTML}</style>
            <div>${$.innerHTML}</div>
        </body>
        
        </html>`]))),b.href=URL.createObjectURL(new Blob([JSON.stringify(u,void 0,4)])),alert("\u5B8C\u6210"),f.classList.remove("pushing")})}y.addEventListener("keydown",t=>g(void 0,null,function*(){t.key==="Enter"&&(yield R())}));f.addEventListener("click",R);
