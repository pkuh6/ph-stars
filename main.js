var g=(t,e,n)=>new Promise((r,u)=>{var m=i=>{try{l(n.next(i))}catch(s){u(s)}},o=i=>{try{l(n.throw(i))}catch(s){u(s)}},l=i=>i.done?r(i.value):Promise.resolve(i.value).then(m,o);l((n=n.apply(t,e)).next())});function a(t,...e){let n=document.createElement(t);return n.append(...e),n}var k=a("input"),y=a("input"),w=a("input"),h=a("button","\u722C\u53D6"),N=a("button","\u4E0B\u8F7D PDF"),P=a("a","\u4E0B\u8F7D JSON"),v=a("div");document.body.append(a("span","\u5F00\u59CB\u65E5\u671F"),k,a("span","\u7ED3\u675F\u65E5\u671F"),y,a("span","Token"),w,h,N,P,v);k.type="date";y.type="date";P.download="hole.json";N.addEventListener("click",()=>{print()});function H(){return g(this,null,function*(){let t=new URL("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php");t.searchParams.set("action","getattention"),t.searchParams.set("PKUHelperAPI","3.0"),t.searchParams.set("jsapiver",`201027113050-${2*Math.floor(Date.now()/72e5)}`),t.searchParams.set("user_token",w.value);try{let e=yield fetch(t);if(!e.ok)return[];let{code:n,data:r}=yield e.json();if(n===0)return r}catch(e){console.error(e)}return[]})}function j(t){return g(this,null,function*(){yield new Promise(e=>setTimeout(e,250));for(let e=0;e<100;e++){let n=new URL("https://pkuhelper.pku.edu.cn/services/pkuhole/api.php");n.searchParams.set("action","getcomment"),n.searchParams.set("pid",t.toString()),n.searchParams.set("PKUHelperAPI","3.0"),n.searchParams.set("jsapiver",`201027113050-${2*Math.floor(Date.now()/72e5)}`),n.searchParams.set("user_token",w.value);try{let r=yield fetch(n);if(!r.ok){yield new Promise(o=>setTimeout(o,3e3));continue}let{code:u,data:m}=yield r.json();if(u===0)return m;yield new Promise(o=>setTimeout(o,3e3));continue}catch(r){console.error(r)}}return alert("\u8FC7\u4E8E\u9891\u7E41"),[]})}function E(t){return g(this,null,function*(){let e=yield j(t);return e.length>1&&Number(e[0].cid)>Number(e[1].cid)&&e.reverse(),e})}function x(){return g(this,null,function*(){var m,o,l,i;if(h.classList.contains("pushing"))return;h.classList.add("pushing");let t,{value:e}=y;e.length===0?t=Math.ceil((Date.now()/1e3+28800)/86400)*86400-28800:t=Math.floor(new Date(`${e} 23:59:59`).getTime()/1e3)+1;let n=t-86400,{value:r}=k;r.length>0&&(n=Math.min(n,Math.floor(new Date(`${r} `).getTime()/1e3))),v.innerHTML="";let u=[];for(let s of yield H()){let $=Number(s.timestamp);if($<n||$>t)continue;let f=a("div"),D=a("div"),L=a("div");v.append(f),f.append(D);let b=Number(s.pid),d=new Date($*1e3);if(D.textContent=`#${b}  ${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}  ${s.likenum} \u6536\u85CF  ${s.reply} \u56DE\u590D  ${(m=s.tag)!=null?m:""}
${(o=s.text)!=null?o:""}`,s.type==="image"&&typeof s.url=="string"){let c=a("img");f.append(c),b>3218523?c.src=`https://pkuhelper.pku.edu.cn/services/pkuhole/images/${s.url}`:c.src=`https://ewr1.vultrobjects.com/ph-static/images/${s.url}`}f.append(L);let M=yield E(b);for(let c of M){let T=a("div");L.append(T);let p=new Date(Number(c.timestamp)*1e3);T.textContent=`#${c.cid}  ${p.getFullYear()}/${p.getMonth()+1}/${p.getDate()} ${p.getHours()}:${p.getMinutes()}:${p.getSeconds()}  ${(l=c.tag)!=null?l:""}
${(i=c.text)!=null?i:""}`}u.push({hole:s,comments:M})}P.href=URL.createObjectURL(new Blob([JSON.stringify(u,void 0,4)])),alert("\u5B8C\u6210"),h.classList.remove("pushing")})}w.addEventListener("keydown",t=>g(void 0,null,function*(){t.key==="Enter"&&(yield x())}));h.addEventListener("click",x);
